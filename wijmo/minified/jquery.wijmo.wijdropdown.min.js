/*
 *
 * Wijmo Library 2.1.3
 * http://wijmo.com/
 *
 * Copyright(c) ComponentOne, LLC.  All rights reserved.
 * 
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * licensing@wijmo.com
 * http://www.wijmo.com/license
 *
 **/
(function(a){"use strict";a.widget("wijmo.wijdropdown",{options:{zIndex:1e3,showingAnimation:{effect:"blind"},hidingAnimation:{effect:"blind"}},hoverClass:"ui-state-hover",activeClass:"ui-state-active",focusClass:"ui-state-focus",_setOption:function(c,b){a.Widget.prototype._setOption.apply(this,arguments);if(c==="disabled"){this._labelWrap.toggleClass("ui-state-disabled",b);this.element.attr("disabled",b?"disabled":"")}},_create:function(){var a=this,b=a.element;if(b.get(0).tagName.toLowerCase()!=="select")return;if(b.is(":visible")){a._activeItem=null;a._createSelect();a._bindEvents();a.needInit=false}else a.needInit=true},_createSelect:function(){var b=this,c=b.element,k=c.width(),f=k,j=c.wrap("<div></div>").parent().addClass("ui-helper-hidden"),d=j.wrap("<div></div>").parent().attr("role","select").addClass("wijmo-wijdropdown ui-widget ui-widwijmo-wijdropdownt-content ui-state-default ui-corner-all ui-helper-clearfix"),h=a('<label class="wijmo-dropdown-label ui-corner-all"></label>').attr("id",c.get(0).id+"_select").attr("name",c.attr("name")||""),i=a("<div></div>").addClass("wijmo-dropdown-trigger ui-state-default ui-corner-right"),e=a('<a href="#"></a>'),g=a("<div>").addClass("wijmo-dropdown"),l=a("<ul></ul>").addClass("wijmo-dropdown-list ui-widget-content ui-widget ui-corner-all ui-helper-reset").appendTo(g);a("<span></span>").addClass("ui-icon ui-icon-triangle-1-s").appendTo(i);k=Math.max(k,d.width());c.get(0).tabIndex!==""&&e.attr("tabindex",c.attr("tabindex"));if(c.get(0).disabled!==false){b.options.disabled=true;e.addClass("ui-state-disabled")}e.append(h);d.append(j).append(e).append(i).append(g);f+=parseInt(h.css("padding-left").replace(/px/,""),10);f+=parseInt(h.css("padding-right").replace(/px/,""),10);f-=16;d.width(f);b._buildList(l,g,f);b._rightTrigger=i;b._label=h;b._listContainer=g;b._list=l;b._value=c.val();b._selectedIndex=a("option",c).index(c.find("option:selected")),b._selectWrap=j;b._labelWrap=e;b._container=d;d.attr("title",c.attr("title"));c.removeAttr("title")},_buildList:function(c,b,f){var d=this,g=d.element,e;b.show();g.children().each(function(i,h){var b=a(h),f,g,e;if(b.is("option"))c.append(d._buildItem(b));else{f=a('<li class="wijmo-dropdown-optgroup"></li>');g=a("<span>"+b.attr("label")+"</span>").addClass("wijmo-optgroup-header ui-priority-primary");e=a("<ul></ul>").addClass("ui-helper-reset wijmo-dropdown-items");b.children("option").each(function(){e.append(d._buildItem(a(this)))});f.append(g).append(e);c.append(f)}});b.height("");e=b.height();e=c.outerHeight()<e?c.outerHeight():e;b.css({height:e,width:f});c.setOutWidth(c.parent().parent().innerWidth()-18);if(b.data("wijsuperpanel")){b.wijsuperpanel("paintPanel");d.superpanel=b.data("wijsuperpanel")}else d.superpanel=b.wijsuperpanel().data("wijsuperpanel");a.fn.bgiframe&&d.superpanel.element.bgiframe();if(!d.superpanel.vNeedScrollBar){c.setOutWidth(c.parent().parent().innerWidth());d.superpanel.refresh()}b.hide()},_handelEvents:function(d){var a=this,b="."+a.widgetName,c=a.element;d.bind("click"+b,function(b){if(a.options.disabled)return;if(a._listContainer.is(":hidden"))a._show();else a._hide();c.click();if(d.get(0)===a._label.get(0))b.preventDefault();else a._labelWrap.focus()}).bind("mouseover"+b,function(){if(a.options.disabled)return;a._label.addClass(a.hoverClass);a._rightTrigger.addClass(a.hoverClass);c.trigger("mouseover")}).bind("mouseout"+b,function(){if(a.options.disabled)return;a._label.removeClass(a.hoverClass);a._rightTrigger.removeClass(a.hoverClass);c.trigger("mouseout")}).bind("mousedown"+b,function(){if(a.options.disabled)return;a._label.addClass(a.activeClass);a._rightTrigger.addClass(a.activeClass);c.trigger("mousedown")}).bind("mouseup"+b,function(){if(a.options.disabled)return;a._label.removeClass(a.activeClass);a._rightTrigger.removeClass(a.activeClass);c.trigger("mouseup")})},_bindEvents:function(){var b=this,d="."+b.widgetName,h=b._label,g=b._rightTrigger,i=b._labelWrap,c=b._listContainer,e=b.element,f;b._handelEvents(b._label);b._handelEvents(b._rightTrigger);a(document.body).bind("click"+d,function(a){if(c.is(":hidden"))return;f=c.offset();if(a.target===h.get(0)||a.target===g.get(0)||a.target===g.children().get(0))return;(a.pageX<f.left||a.pageX>f.left+c.width()||a.pageY<f.top||a.pageY>f.top+c.height())&&b._hide()});c.bind("click"+d,function(f){var d=a(f.target);if(d.closest("li.wijmo-dropdown-item",a(this)).length>0){b._setValue();c.css("z-index","");a.browser.msie&&/^[6,7].[0-9]+/.test(a.browser.version)&&c.parent().css("z-index","");c.hide();b._setValueToEle()}e.click()});i.bind("keydown"+d,function(d){if(b.options.disabled)return;var c=a.ui.keyCode;switch(d.which){case c.UP:case c.LEFT:b._previous();b._setValue();b._setValueToEle();break;case c.DOWN:case c.RIGHT:b._next();b._setValue();b._setValueToEle();break;case c.PAGE_DOWN:b._nextPage();b._setValue();b._setValueToEle();break;case c.PAGE_UP:b._previousPage();b._setValue();b._setValueToEle();break;case c.ENTER:case c.NUMPAD_ENTER:b._setValue();b._listContainer.hide();b._setValueToEle()}d.which!==c.TAB&&d.preventDefault();e.trigger("keydown")}).bind("focus"+d,function(){if(b.options.disabled)return;h.addClass(b.focusClass);g.addClass(b.focusClass);e.focus()}).bind("blur"+d,function(){if(b.options.disabled)return;h.removeClass(b.focusClass);g.removeClass(b.focusClass);e.trigger("blur")}).bind("keypress"+d,function(){if(b.options.disabled)return;e.trigger("keypress")}).bind("keyup"+d,function(){if(b.options.disabled)return;e.trigger("keyup")})},_init:function(){var a=this;a._initActiveItem();a._activeItem&&a._label.text(a._activeItem.text())},_buildItem:function(d){var f=d.val(),b=d.text(),e=this,c;if(b==="")b="&nbsp;";c=a('<li class="wijmo-dropdown-item ui-corner-all"><span>'+b+"</span></li>").mousemove(function(b){var c=a(b.target).closest(".wijmo-dropdown-item");c!==this.last&&e._activate(a(this));this.last=a(b.target).closest(".wijmo-dropdown-item")}).attr("role","option");c.data("value",f);return c},_show:function(){var d=this,c=d._listContainer,b=d.options.showingAnimation;c.css("z-index","100000");a.browser.msie&&/^[6,7]\.[0-9]+/.test(a.browser.version)&&c.parent().css("z-index","99999");if(b)c.show(b.effect,b.options,b.speed,function(){d._initActiveItem()});else c.show()},_hide:function(){var d=this,b=d._listContainer,c=d.options.hidingAnimation;if(b.is(":hidden"))return;if(c)b.hide(c.effect,c.options,c.speed,function(){a.isFunction(c.callback)&&c.callback.apply(d,arguments);a.browser.msie&&/^[6,7]\.[0-9]+/.test(a.browser.version)&&b.parent().css("z-index","");b.css("z-index","")});else{a.browser.msie&&a.browser.version==="6.0"&&b.parent().css("z-index","");b.css("z-index","");b.hide()}},_setValue:function(){var b=this,c=b._listContainer,d,e;if(b._activeItem){b._label.text(b._activeItem.text());b._value=b._activeItem.data("value");b._selectedIndex=a("li.wijmo-dropdown-item",c).index(b._activeItem);if(b.superpanel.vNeedScrollBar){d=b._activeItem.offset().top;e=b._activeItem.outerHeight();if(c.offset().top>d)c.wijsuperpanel("scrollTo",0,d-b._list.offset().top);else c.offset().top<d+e-c.innerHeight()&&c.wijsuperpanel("scrollTo",0,d+e-c.height()-b._list.offset().top)}}},_setValueToEle:function(){var e=this,b=e.element,c=b.find("option[selected]"),f=a("option",b).index(c),d=e._selectedIndex;if(f!==d){c.removeAttr("selected");b.find("option:eq("+d+")").attr("selected",true);b.trigger("change")}},_initActiveItem:function(){var b=this;if(b._value!==undefined){if(b._selectedIndex===-1){b._activate(b._list.find("li.wijmo-dropdown-item").eq(0));return}b._list.find("li.wijmo-dropdown-item").each(function(c){if(c===b._selectedIndex){b._activate(a(this));return false}})}},_activate:function(b){var a=this;a._deactivate();a._activeItem=b;a._activeItem.addClass(a.hoverClass).attr("aria-selected",true)},_deactivate:function(){var a=this;a._activeItem&&a._activeItem.removeClass(a.hoverClass).attr("aria-selected",false)},_next:function(){this._move("next","first")},_previous:function(){this._move("prev","last")},_nextPage:function(){this._movePage("first")},_previousPage:function(){this._movePage("last")},refresh:function(){var b=this,c;if(b.needInit){if(b.element.is(":visible")){b._activeItem=null;b._createSelect();b._bindEvents();b._init();b.needInit=false}}else{if(!b._list)return;b._listContainer.show();b._selectWrap.removeClass("ui-helper-hidden");c=b.element.width();c+=parseInt(b._label.css("padding-left").replace(/px/,""),10);c+=parseInt(b._label.css("padding-right").replace(/px/,""),10);c-=16;b._container.width(c);b._selectWrap.addClass("ui-helper-hidden");b._list.empty();b._buildList(b._list,b._listContainer,c);b._value=b.element.val();b._selectedIndex=a("option",ele).index(ele.find("option:selected")),b._initActiveItem();b._activeItem&&b._label.text(b._activeItem.text())}},_move:function(c,d){var a=this,e,b;if(!a._activeItem){a._activate(a._list.find(".wijmo-dropdown-item:"+d));return}e=a._activeItem[c]().eq(0);if(e.length)b=a._getNextItem(e,c,d);else if(a._activeItem.closest(".wijmo-dropdown-optgroup").length)b=a._getNextItem(a._activeItem.closest(".wijmo-dropdown-optgroup")[c](),c,d);if(b&&b.length)a._activate(b);else a._activate(a._list.find(".wijmo-dropdown-item:"+d))},_movePage:function(d){var b=this,g,e,c,f=d==="first"?"last":"first";if(b.superpanel.vNeedScrollBar){g=b._activeItem.offset().top;e=b.options.height;c=b._list.find(".wijmo-dropdown-item").filter(function(){var c=a(this).offset().top-g+(d==="first"?-e:e)+a(this).height(),b=a(this).height();return c<b&&c>-b});if(!c.length)c=b._list.find(".wijmo-dropdown-item:"+f);b._activate(c)}else b._activate(b._list.find(".wijmo-dropdown-item:"+(!b._activeItem?d:f)))},_getNextItem:function(a,b,c){if(a.length)if(a.is(".wijmo-dropdown-optgroup"))if(!!a.find(">ul>li.wijmo-dropdown-item").length)return a.find(">ul>li.wijmo-dropdown-item:"+c).eq(0);else this._getNextItem(a[b]().eq(0));else return a},destroy:function(){this.element.attr("title",this._container.attr("title"));this.element.closest(".wijmo-wijdropdown").find(">div.wijmo-dropdown-trigger,>div.wijmo-dropdown,>a").remove();this.element.unwrap().unwrap().removeData("maxZIndex");a.Widget.prototype.destroy.apply(this)}})})(jQuery);